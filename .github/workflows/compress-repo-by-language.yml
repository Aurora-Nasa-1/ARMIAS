name: Compress Repository by Language

on:
  push:
    branches: [ main ] # 根据实际情况替换分支名

jobs:
  compress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # 获取所有历史记录，以便能够找到最新的 tag

      - name: Get latest tag
        id: latest-tag
        run: |
          LATEST_TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
          echo "::set-output name=tag::$LATEST_TAG"

      - name: Compress repository for each language version
        run: |
          languages=("en" "jp" "zh")
          LATEST_TAG=${{ steps.latest-tag.outputs.tag }}
          
          for lang in "${languages[@]}"; do
            if [ -d "languages/$lang" ]; then
              rm -f "languages/$lang"/README.md "languages/$lang"/README_*.md
              
              zip -r "${LATEST_TAG}_${lang}.zip" "languages/$lang" -x *.git*
            fi
          done

      - name: Upload zip files as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: compressed-repository-by-language-and-tag
          path: |
            *.zip