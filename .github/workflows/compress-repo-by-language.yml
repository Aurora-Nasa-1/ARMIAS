name: Compress Repository by Language

on:
  push:
    branches: [ main ] # 根据实际情况替换分支名

jobs:
  compress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Compress repository for each language version
        run: |
          languages=("en" "jp" "zh")
          
          for lang in "${languages[@]}"; do
            # 删除 languages 文件夹以外的其他语言文件夹
            find languages -maxdepth 1 -mindepth 1 -type d ! -name "$lang" -exec rm -rf {} +
            
            # 删除所有的 README.md 文件
            rm -f README.md README_*.md
            
            # 如果 languages/$lang 目录存在，则将其内容移动到根目录
            if [ -d "languages/$lang" ]; then
              mv "languages/$lang"/* .
              rmdir "languages/$lang" # 删除空的语言目录
            fi
            
            # 如果此时 languages 文件夹为空，则删除它
            rmdir languages 2>/dev/null || true # 忽略非空文件夹的错误
            
            # 压缩当前语言版本的仓库，排除 .git 目录和其他不需要的文件
            zip -r "repo_$lang.zip" . -x *.git* *.md
            
            # 恢复 languages 文件夹以供下一次循环使用
            git checkout -- languages
          done

      - name: Upload zip files as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: compressed-repository-by-language
          path: |
            repo_en.zip
            repo_jp.zip
            repo_zh.zip